#include <msp430.h>

// Servo positions
unsigned int pos0   = 350;   // 0 degrees
unsigned int pos180 = 2600;  // 180 degrees
volatile unsigned char toggle = 0;

int main(void)
{
    WDTCTL = WDTPW | WDTHOLD;   // Stop watchdog timer

    // Clock Setup (1 MHz)
    BCSCTL1 = CALBC1_1MHZ;
    DCOCTL  = CALDCO_1MHZ;

    // Servo PWM Pin Setup (P1.6 = TA0.1)
    P1DIR |= BIT6;
    P1SEL |= BIT6;

    // Button setup on P1.3
    P1DIR &= ~BIT3;      // Input
    P1REN |= BIT3;       // Enable resistor
    P1OUT |= BIT3;       // Pull-up resistor

    // Enable interrupt on P1.3 (falling edge)
    P1IE  |= BIT3;       // Enable interrupt
    P1IES |= BIT3;       // High to Low edge (button press)
    P1IFG &= ~BIT3;      // Clear interrupt flag

    // Timer A setup
    TACCR0  = 20000;             // 20 ms period
    TACCTL1 = OUTMOD_7;          // Reset/set PWM mode
    TACCR1  = pos0;              // Start at 0 degrees
    TACTL   = TASSEL_2 | MC_1;   // SMCLK, UP mode

    __bis_SR_register(GIE);      // Enable global interrupts

    while (1)
    {
        // main loop does nothing - servo is controlled by interrupt
        __no_operation();
    }
}

// Port 1 ISR
#pragma vector=PORT1_VECTOR
__interrupt void Port_1_ISR(void)
{
    __delay_cycles(20000);  // Debounce (20ms)

    if (!(P1IN & BIT3))     // Still pressed?
    {
        if (toggle == 0)
        {
            TACCR1 = pos180;    // Move to 180 degrees
            toggle = 1;
        }
        else
        {
            TACCR1 = pos0;      // Move to 0 degrees
            toggle = 0;
        }
    }

    // Clear interrupt flag
    P1IFG &= ~BIT3;
}

