#include <msp430.h>

// MSP430G2ET with SG90 Servo and one Push Button
// Button on P1.3, Servo signal on P1.6 (Timer_A0.1 output)

void delay_ms(unsigned int ms);

void main(void)
{
    WDTCTL = WDTPW | WDTHOLD;   // Stop watchdog timer

    // Set DCO to 1 MHz
    BCSCTL1 = CALBC1_1MHZ;
    DCOCTL = CALDCO_1MHZ;

    // Servo PWM Setup
    P1DIR |= BIT6;     // P1.6 output
    P1SEL |= BIT6;     // P1.6 = TA0.1 (Timer_A output)

    // Button Setup (P1.3)
    P1DIR &= ~BIT3;    // P1.3 input
    P1REN |= BIT3;     // Enable internal resistor
    P1OUT |= BIT3;     // Use pull-up resistor (HIGH when not pressed)

    // Timer_A Setup for PWM
    TACCR0 = 20000;           // PWM period = 20ms (50Hz)
    TACCTL1 = OUTMOD_7;       // Reset/set mode
    TACTL = TASSEL_2 | MC_1;  // SMCLK, up mode

    // Servo positions
    unsigned int pos0 = 350;     // ~0 degrees
    unsigned int pos180 = 2600;  // ~180 degrees
    unsigned int i;

    TACCR1 = pos0;  // Start at 0 degrees

    while (1)
    {
        // Check if button pressed (active low)
        if (!(P1IN & BIT3))
        {
            __delay_cycles(20000); // Debounce delay (~20ms)
            if (!(P1IN & BIT3))    // Confirm it's still pressed
            {
                // Move fast to 180 degrees
                TACCR1 = pos180;
                delay_ms(300);   // wait 0.3s at 180Â°

                // Return slowly to 0 degrees
                for (i = pos180; i > pos0; i -= 20)
                {
                    TACCR1 = i;
                    delay_ms(20);
                }

                TACCR1 = pos0;   // final exact position

                // Wait for button release
                while (!(P1IN & BIT3));
                __delay_cycles(20000); // debounce release
            }
        }
    }
}

// Delay function (1ms at 1 MHz)
void delay_ms(unsigned int ms)
{
    while (ms--)
        __delay_cycles(1000);
}
